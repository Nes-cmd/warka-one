# Enable Rewrite Engine
RewriteEngine On

# Slowloris Protection
<IfModule mod_reqtimeout.c>
    # Set timeouts for request headers and body
    RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
</IfModule>

<IfModule mod_evasive24.c>
    # Enable mod_evasive if available (install separately)
    DOSHashTableSize    2048
    DOSPageCount        3
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

# Limit request size to prevent large payload attacks
<IfModule mod_security.c>
    SecRequestBodyLimit 10485760
    SecRequestBodyNoFilesLimit 131072
</IfModule>

<IfModule mod_headers.c>
    # Allow specific domains for cross-origin requests
    Header always set Access-Control-Allow-Origin %{AccessControlAllowOrigin}e env=AccessControlAllowOrigin

    # Allow methods and headers
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

    # Optional: Allow credentials if needed
    # Header always set Access-Control-Allow-Credentials "true"
</IfModule>

# Handle preflight OPTIONS requests
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# Block known WordPress attack paths
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_URI} ^/wordpress/wp-admin/setup-config\.php$ [NC,OR]
    RewriteCond %{REQUEST_URI} ^/wp-admin [NC,OR]
    RewriteCond %{REQUEST_URI} ^/wp-login\.php$ [NC]
    RewriteRule .* - [F]
</IfModule>


# Redirect www to non-www
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^(.*)$ http://%1/$1 [R=301,L]

# Redirect HTTP to HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Set default index file
RewriteRule ^(.*)$ public/$1 [L]

# Rewrite rule for root URL to index.php
RewriteRule ^$ public/index.php [L]

# General rule to forward all requests to index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . public/index.php [L]

# Deny access to .htaccess file itself
<Files .htaccess>
    Order allow,deny
    Deny from all
</Files>

# Prevent directory listing
Options -Indexes

# Protect against some common exploits
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "DENY"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Connection management headers for security
    Header always set Connection "close"
    Header always set Keep-Alive "timeout=5, max=100"
    
    # Note: CSP is now handled by Laravel middleware for nonce-based security
    # Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://fonts.bunny.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://fonts.bunny.net; img-src 'self' data: https://ui-avatars.com; font-src 'self' https://fonts.gstatic.com https://fonts.bunny.net; connect-src 'self'; frame-src 'self';"
</IfModule>

# Set default charset
AddDefaultCharset UTF-8

# MIME types
# AddType application/x-httpd-php .php
# AddType text/html .html

# Custom error pages
ErrorDocument 400 /400.html
ErrorDocument 401 /401.html
ErrorDocument 403 /403.html
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# Caching static content for 1 week
<FilesMatch "\.(ico|jpg|jpeg|png|gif|js|css|svg|woff|woff2|eot|ttf|otf)$">
    ExpiresActive On
    ExpiresDefault "access plus 1 week"
</FilesMatch>

# Enable gzip compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
</IfModule>

# Prevent access to sensitive files
<FilesMatch "\.(env|json|lock|gitignore|gitattributes|log|htaccess|htpasswd)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Allow Cross-Domain Font Requests
<IfModule mod_headers.c>
    <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font.css)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# Disable server signature
ServerSignature Off

# Disable directory brows